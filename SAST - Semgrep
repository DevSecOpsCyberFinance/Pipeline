pipeline {
  agent any

  parameters {
    booleanParam(name: 'FAIL_ON_FINDINGS', defaultValue: false, description: 'Si true -> el job falla si hay vulnerabilidades.')
    string(name: 'SEMGREP_CONFIG', defaultValue: 'auto', description: 'Configuración para semgrep (ej: auto, ruta/a/reglas.yml, o un pack como p/owasp-top-10).')
    string(name: 'SRC', defaultValue: '/projects/Cyberfinance-Bank-main', description: 'Ruta fuente en el nodo donde están los repositorios/proyectos.')
    string(name: 'ANALYZE_TARGETS', defaultValue: 'Backend,Frontend', description: 'Targets a analizar (CSV), p.ej. Backend,Frontend o src/dir1,src/dir2.')
  }

  environment {
    IMG = 'returntocorp/semgrep:latest'
  }

  stages {
    stage('Prepare workspace (rsync without owner/perms)') {
      steps {
        sh """
          set -e
          rm -rf "${env.WORKSPACE}"/* || true
          rsync -r --delete --exclude='.git' --exclude='node_modules' \\
            --no-owner --no-group --no-perms \\
            --chmod=Du=rwx,Dg=rx,Do=rx,Fu=rw,Fg=r,Fo=r \\
            "${params.SRC}/" "${env.WORKSPACE}/"
          echo "Permisos y contenido del workspace:"
          ls -ld "${env.WORKSPACE}"
          ls -l "${env.WORKSPACE}" | head -n 50
        """
      }
    }

    stage('Semgrep (sequential)') {
      steps {
        script {
          def config = (params.SEMGREP_CONFIG ?: 'auto').trim()
          echo "SEMGREP_CONFIG seleccionado: '${config}'"

          def uid = sh(script: 'id -u', returnStdout: true).trim()
          def gid = sh(script: 'id -g', returnStdout: true).trim()
          echo "Usando UID:GID = ${uid}:${gid} para docker run"

          def targets = (params.ANALYZE_TARGETS ?: '').tokenize(',').collect { it.trim() }.findAll { it }
          if (targets.isEmpty()) {
            echo "ANALYZE_TARGETS vacío — nothing to scan."
          } else {
            for (t in targets) {
              def safe = t.replaceAll(/[\\/\\s]+/, '-')
              echo "Analizando target: ${t} -> semgrep-${safe}.json (config=${config})"
              sh """
                set -e
                docker run --rm -u ${uid}:${gid} -e HOME=/tmp -v "${env.WORKSPACE}":/src ${IMG} \\
                  semgrep scan --config='${config}' --json --output /src/semgrep-${safe}.json /src/${t} || true
              """
            }
          }
        }
      }
      post {
        always {
          archiveArtifacts artifacts: 'semgrep-*.json', allowEmptyArchive: true, fingerprint: true
        }
      }
    }

    stage('Summarize & conditional exit') {
      steps {
        sh '''
          set -euo pipefail

          rm -f semgrep-report-summary.txt
          total=0

          for f in semgrep-*.json; do
            [ -f "$f" ] || continue

            cnt=$(python3 -c "import json,sys; print(len(json.load(open(sys.argv[1])).get('results',[])))" "$f" 2>/dev/null || echo 0)

            case "$cnt" in ''|*[!0-9]*) cnt=0 ;; esac

            echo "$f=$cnt" >> semgrep-report-summary.txt
            total=$(( total + cnt ))
          done

          if [ ! -f semgrep-report-summary.txt ]; then
            echo "total_findings=0" > semgrep-report-summary.txt
          else
            echo "total_findings=${total}" >> semgrep-report-summary.txt
          fi

          cat semgrep-report-summary.txt

          if [ "${FAIL_ON_FINDINGS:-false}" = "true" ] && [ "${total:-0}" -gt 0 ]; then
            echo "FAIL_ON_FINDINGS=true y total>0 -> saliendo con código 1"
            exit 1
          fi

          exit 0
        '''
      }
      post {
        always {
          archiveArtifacts artifacts: 'semgrep-report-summary.txt', allowEmptyArchive: true, fingerprint: true
          sh 'echo "Summary: $(cat semgrep-report-summary.txt 2>/dev/null || echo no-summary)"'
        }
      }
    }

  } // end stages

  post {
    success { echo "Security pipeline: final SUCCESS." }
    failure { echo "Security pipeline: final FAILURE (revisa artefactos)." }
  }
}
